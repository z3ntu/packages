# Maintainer: Allan McRae <allan@archlinux.org>

# cross toolchain build order: binutils, gcc (pass 1), gnumach-headers, mig, hurd-headers,
#                              glibc (pass 1), libpthread, gcc (pass 2), glibc (pass 2)

# notes: first two patches fail.
#        no crt1.o file produced :(

_target=i686-pc-gnu
_sysroot=/usr/lib/cross-${_target}
_pass=1   # 1 or 2

pkgname=cross-${_target}-glibc
pkgver=20100106
pkgrel=1
pkgdesc="Hurd cross-toolchain GNU C Library"
arch=('i686' 'x86_64')
url="http://www.gnu.org/software/libc"
license=('GPL' 'LGPL')
groups=('base')
depends=("cross-${_target}-gnumach-headers" "cross-${_target}-hurd-headers")
makedepends=("cross-${_target}-gcc" "git")
source=('0009-2007-07-22-version-of-init-first.c_vs._GCC_4.1.patch'
  '0011-2007-02-08-version-of-resolv_res_send.c.patch.patch'
  '0003-2007-09-13-H.J.-Lu-hongjiu.lu-intel.com.patch'
  '0005-Hurd-specific-kernel-features.h.patch'
  '0007-2007-10-05-version-of-stat.patch'
  '0008-r2425-of-debian-patches-hurd-i386-local-atomic-no-mu.patch'
  '0010-r2425-of-debian-patches-hurd-i386-local-gscope.diff.patch'
  '0012-r2425-of-debian-patches-hurd-i386-local-no-strerror_.patch'
  '0013-r2626-of-debian-patches-hurd-i386-local-tls-support.patch'
  '0014-r2591-of-debian-patches-hurd-i386-local-tls.diff.patch'
  '0015-r2630-of-debian-patches-hurd-i386-submitted-libc_onc.patch'
  '0016-Include-stdint.h.patch'
  '0017-r2598-of-debian-patches-any-local-stdio-lock.diff.patch'
  '0018-r2650-of-debian-patches-hurd-i386-submitted-strtoul.patch'
  '0019-2007-11-12-Aurelien-Jarno-aurelien-aurel32.net-Tho.patch'
  '0020-r2656-of-debian-patches-any-submitted-sched_h.diff.patch'
  '0022-2007-11-18-Roland-McGrath-roland-frob.com.patch')
md5sums=('680a775484ec811a9eb52b2c5f43c5ca' 'cc273d14e314522a8ba3017859c6e089'\
         '57771280464dd2c65f00c9e44caff348' 'c641b520a27a7de357517a8884bafb87'\
         '89749b31945a6c162c14cb1792c81072' '7102cce3402901683ab46b2928ca6b0e'\
         '6e4a9bc45a2bf4b523636f3c149eba61' '594a6f80e0cc5039111a63b64e9b679d'\
         'b75581aa00d307f5db2f52d0aac67f8a' '5127dbf88a50f9d9b540db79410f59c7'\
         'efe7110f7d53428867fb61e9047cac5a' '4e70d096b96840316664f3d70695ff6d'\
         'd176f3e3acd9b7b13912c131292c7f3e' 'f40ad29d3199d2c5326a976cb29cd7aa'\
         '4d90a58ef34de9419c1f4c41411f041d' 'cf5e65ad5613df95de0eb3f5a18eb451'\
         'd898733da52a4c10b9c84507050fadbc')

_gitroot="git://sourceware.org/git/glibc.git"
_gitname="glibc"

build() {
  cd $srcdir

  msg "Connecting to GIT server...."
  if [ -d $_gitname ]; then
    cd $_gitname
    git checkout glibc-2_7-branch
    git pull origin
    msg "The local files are updated."
  else
    git clone $_gitroot --no-checkout
    cd $_gitname
    git checkout --track -b glibc-2_7-branch remotes/origin/cvs/glibc-2_7-branch
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  patch -p1 < ../../0009-2007-07-22-version-of-init-first.c_vs._GCC_4.1.patch || return 1
  patch -p1 < ../../0011-2007-02-08-version-of-resolv_res_send.c.patch.patch || return 1
  patch -p1 < ../../0003-2007-09-13-H.J.-Lu-hongjiu.lu-intel.com.patch || return 1
  patch -p1 < ../../0005-Hurd-specific-kernel-features.h.patch || return 1
  patch -p1 < ../../0007-2007-10-05-version-of-stat.patch || return 1
  patch -p1 < ../../0008-r2425-of-debian-patches-hurd-i386-local-atomic-no-mu.patch || return 1
  patch -p1 < ../../0010-r2425-of-debian-patches-hurd-i386-local-gscope.diff.patch || return 1
  patch -p1 < ../../0012-r2425-of-debian-patches-hurd-i386-local-no-strerror_.patch || return 1
  patch -p1 < ../../0013-r2626-of-debian-patches-hurd-i386-local-tls-support.patch || return 1
  patch -p1 < ../../0014-r2591-of-debian-patches-hurd-i386-local-tls.diff.patch || return 1
  patch -p1 < ../../0015-r2630-of-debian-patches-hurd-i386-submitted-libc_onc.patch || return 1
  patch -p1 < ../../0016-Include-stdint.h.patch || return 1
  patch -p1 < ../../0017-r2598-of-debian-patches-any-local-stdio-lock.diff.patch || return 1
  patch -p1 < ../../0018-r2650-of-debian-patches-hurd-i386-submitted-strtoul.patch || return 1
  patch -p1 < ../../0019-2007-11-12-Aurelien-Jarno-aurelien-aurel32.net-Tho.patch || return 1
  patch -p1 < ../../0020-r2656-of-debian-patches-any-submitted-sched_h.diff.patch || return 1
  patch -p1 < ../../0022-2007-11-18-Roland-McGrath-roland-frob.com.patch || return 1

  mkdir build && cd build

  ../configure --prefix= \
    --build=$CHOST --host=${_target} --target=${_target} \
    --without-cvs --disable-profile \
    --with-headers=${_sysroot}/include \
    --without-tls

  if [ ${_pass} -eq 1 ]; then
    # build errors are expected as gcc and libpthread are not complete/installed
    # force finishing make
    make -k || echo
    make -k install_root=$pkgdir/${_sysroot} install || echo
  else
    make
    make install_root=$pkgdir/${_sysroot} install
  fi
}
