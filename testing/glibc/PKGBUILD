# Maintainer Matthias Lanzinger <mlaenz@gmail.com>
# Note: For now there is now way around the ridiculous amount of patching :(

pkgname=glibc
pkgver=2.11.20100413git
pkgrel=3
pkgdesc="GNU C Library"
arch=(i686)
url="http://www.gnu.org/software/libc"
license=('GPL','LGPL')
groups=('base')
depends=('hurd')
makedepends=('hurd' 'gcc>=4.3')

source=(locale.gen.txt
        locale-gen
        Fix-linkat-on-Hurd2.patch
        i686-cpuclock_which.patch
        local-pthread.diff
        local-pthread_posix-option.diff
        local-pthread_types.diff
        local-pthread-unsupported-stubs.diff) 

md5sums=('07ac979b6ab5eeb778d55f041529d623'
         '476e9113489f93b348b21e144b6a8fcf'
        '6520497a63a8f031042d81e39e4dabdd'
         '1a6638ab233513400c520e9230612ece'
         '5325c498384ca533c3d20f6fd1047cca'
         'a0070eaa18ad119c742e1da576109add'
         '293e19249d7b20a2d2f221fd93b7d231'
         '0d8bb94dc5a9f97cbf6e8502ba818fcd')



__gitroot="git://git.sv.gnu.org/hurd/glibc.git"

build() {  
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d glibc-git ] ; then
    cd glibc-git && git pull origin tschwinge/Roger_Whittaker
    msg "The local files are updated."
  else
    git clone --no-checkout $__gitroot glibc-git
    cd glibc-git
    git checkout origin/tschwinge/Roger_Whittaker
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$pkgname" "$srcdir/build"
  cp -r "$srcdir/glibc-git" "$srcdir/$pkgname"
  cd "$srcdir/$pkgname"

  #Patching here
  patch -p1 < "$srcdir/i686-cpuclock_which.patch" || return 1
  patch -p1 < "$srcdir/Fix-linkat-on-Hurd2.patch" || return 1
  
  /* pthread... */
  patch -p1 < "$srcdir/local-pthread.diff
  patch -p1 < "$srcdir/local-pthread_posix-option.diff
  patch -p1 < "$srcdir/local-pthread_types.diff
  patch -p1 < "$srcdir/local-pthread-unsupported-stubs.diff
  
  mkdir "$srcdir/build"
  cd "$srcdir/build"

  ../$pkgname/configure --prefix= --build=$CHOST --libexecdir=/lib \
              --without-gd --without-cvs --disable-multi-arch \
              --disable-profile \
  make || return 1
}

package() {
  cd "$srcdir/build"
  make install_root="$pkgdir/" install || return 1

  install -dm755 ${pkgdir}/lib/locale
  install -m755 ${srcdir}/locale-gen ${pkgdir}/sbin

  # create /etc/locale.gen
  install -m644 ${srcdir}/locale.gen.txt ${pkgdir}/etc/locale.gen
  sed -i "s|/| |g" ${srcdir}/$pkgname/localedata/SUPPORTED
  sed -i 's|\\| |g' ${srcdir}/$pkgname/localedata/SUPPORTED
  sed -i "s|SUPPORTED-LOCALES=||" ${srcdir}/$pkgname/localedata/SUPPORTED
  cat ${srcdir}/glibc/localedata/SUPPORTED >> ${pkgdir}/etc/locale.gen
  sed -i "s|^|#|g" ${pkgdir}/etc/locale.gen
    
  cd $pkgdir/lib
  ln -s ld.so.1 ld.so
}

