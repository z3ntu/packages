# Maintainer: Stephen Gilles <stephendgilles@gmail.com>

pkgname=inetutils
pkgver=1.8
pkgrel=4
pkgdesc="A collection of common network programs"
arch=('i686')
url="http://www.gnu.org/software/inetutils/"
license=('GPL')
replaces=('hostname')
provides=('hostname')
groups=('base')
depends=('readline' 'ncurses' 'pam')
backup=('etc/conf.d/ftpd' 'etc/xinetd.d/telnet' 'etc/xinetd.d/talk')
options=('!emptydirs')
install=inetutils.install
source=(http://ftp.gnu.org/gnu/inetutils/${pkgname}-${pkgver}.tar.gz \
        ftpd.rc ftpd.conf telnet.xinetd talk.xinetd 
	no_eth0_segfault.patch)

build() {
  ## stupid hack to fix a stupid problem.
  ## somethings up with ./configure, and this is the fastest way to fix.
  cd "${srcdir}/${pkgname}-${pkgver}/ifconfig"
  mv flags.h flags.h.bak
  echo "#include <stdlib.h>" > flags.h
  cat flags.h.bak >> flags.h
  ## end stupid hack
  
  ## now apply the patch that fixes segfaulting with no devices
  # for some reason, breaks...
  # cd "${srcdir}/${pkgname}-${pkgver}/ifconfig"
  # patch -Rup0 options.c < ${srcdir}/no_eth0_segfault.patch
  ## patch applied

  cd "${srcdir}/${pkgname}-${pkgver}"
  ./configure --prefix= --libexec=/sbin --localstatedir=/var \
    --mandir=/share/man --infodir=/share/info \
    --without-wrap --with-pam \
    --enable-ftp --enable-ftpd \
    --enable-telnet --enable-telnetd \
    --enable-talk --enable-talkd \
    --disable-rlogin --disable-rlogind \
    --disable-rsh --disable-rshd \
    --disable-rexec --disable-rexecd \
    --disable-rcp \
    --disable-tftp --disable-tftpd \
    --enable-ping --enable-ping6 \
    --disable-logger --enable-syslogd \
    --enable-inetd --enable-whois \
    --disable-uucpd --enable-hostname \
    --enable-ifconfig --disable-traceroute
  make
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  make DESTDIR="${pkgdir}" install

  install -D -m755 "${srcdir}/ftpd.rc" "${pkgdir}/etc/rc.d/ftpd"
  install -D -m644 "${srcdir}/ftpd.conf" "${pkgdir}/etc/conf.d/ftpd"
  install -D -m644 "${srcdir}/telnet.xinetd" "${pkgdir}/etc/xinetd.d/telnet"
  install -D -m644 "${srcdir}/talk.xinetd" "${pkgdir}/etc/xinetd.d/talk"

  # fix conflict with every other package...
  if [ -e ${pkgdir}/share/info/dir ]; then
    rm ${pkgdir}/share/info/dir
  fi
}
md5sums=('ad8fdcdf1797b9ca258264a6b04e48fd'
         'abb31b95485802d23b7df3f96fa3c75a'
         'e6e6e5990a2e8159a276fef8fbf54c04'
         '433b6535e931f22654102de62402d76e'
         'c84c281926ec95095971a666b3b11516'
         'a04025e6a02649e2c8c26dc649900ea5')
